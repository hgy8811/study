## 包月逻辑
###  启动检查是否显示入口

1. ListenSlideFragment->onViewCreated()
2. WorkerHandler-> MSG_GET_SIM_CARD
3. IMSIInfo info=GetIMSIInfoUtil.getInstance(KGCommonApplication.getContext()).getDualTelphoneInfos();
4. UIHandler -> MSG_GET_SIM_CARD [IMSIInfo参数]
5. setupMonthlytrafficViewVisible [IMSIInfo参数] (通过判断imsi的有效性来决定入口是否显示)


### 点击进入包月H5页
* Query 标准卡

```java
String avaiableSim=TrafficMonthlyUtil.queryStandradSimCard(fragment.getContext(),false,true);
```

* 进入包月H5页

```java
NavigationMoreUtils.startMonthlyTrafficActivity(sim,fragment.getContext());

```

### 获取标准卡  - [双卡的选择问题]

双卡的优先级: 优先走流量的卡 -> 开通包月的卡 -> 可包月的卡 -> 主卡 [主卡是根据接口获取的顺序决定的]


### Tips:
* 入口显示，只需要获取卡的信息，判断卡是否支持包月就可以了

* 进入包月H5，不仅需要获取卡的信息，还需要判断是用哪一张卡来包月[多卡]

* 识别到包月的卡后，查询其包月状态[疑惑的地方，为嘛要查询？因为进入H5页后它也会查询状态].

### 加密坑

//md5(运营商标识+酷狗ID+手机号码+客户端sim卡号+url+KEY)
但url的形式有种 ： 1-[http://musiclib.service.kugou.com/v1/multi/recommend] 2.[http://www.kugou.com/t/?id=507484977]

* 服务端若是用真实的访问地址来解密，存在业务上层不知道真实地址的情况。如fm播放，多段数据相对地址是写在一个特定文件内的，底层播放器去下载播放，底层修改太困难，故排除
* 服务端若用真实地址的不带参数段[即?之前的部分来解密],存在业务上层获取的代码格式不一定符合，可能是已拼接好的url[即带?],所以需要业务上层去处理，取得符合的加密段

* 现在是上层处理url截取对应部分，成为符合要求的段


### 免流失败坑 [不包含下载引擎的部分]

* 代理失败后 若返回984/985则重新查询一
下包月状态,若非包月则不走免流代理，否则继续走
* 代理失败后 查询包月状态为服务可用 则走vip通道,一次使用VIP通道，在这次启动中都用VIP通道
* 代理失败后 查询包月服务不可用，则弹出免流失败提示框

### 名词解释

* VIP通道：联通包月代理的普通通道会校验手机号与simno的绑定关系且完全一致, 当普通通道报984/985时客户端依然认为用户需要免流时走vip绿色通道（vip绿色通道不做完全的绑定关系的校验）


### 文档资源

1. http://kgmedit.kugou.com/apidocs/cmccservice/ 在线文档

2. 错误码：
 984：手机号和simno不一致
 985：用户没有订阅酷狗服务或已经失效
 986：没有代理头信息
 987：提交的参数验证失败
 988：VIP限制通过
 989：获取当月流量统计信息失败
 990：流量超标
